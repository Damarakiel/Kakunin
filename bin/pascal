#!/usr/bin/env node

const commandArgs = require('minimist')(process.argv.slice(2));
const path = require('path');
const child_process = require('child_process');
const envfile = require('node-env-file');
const initializer = require('../src/helpers/initializer');

const isInitCommand = () => {
  return process.argv.length > 2 && process.argv[2] === 'init';
}

const getConfigPath = () => {
  const configFile = 'pascal.conf.js';

  return (commandArgs.pascalConfig)
    ? process.cwd() + '/' + commandArgs.pascalConfig
    : process.cwd() + '/' + configFile;
}

const getScenariosTags = () => {
  const tags = [];

  if (commandArgs.tags !== undefined) {
    tags.push('--cucumberOpts.tags');
    tags.push(commandArgs.tags);
  }

  return tags;
}

envfile(process.cwd() + '/.env', { raise: false, overwrite: false });

if (isInitCommand()) {
  (async () => {
    await initializer.initConfig();
    await initializer.initEnv();
    await initializer.generateProjectStructure();
  })();
} else {
  const optionsToFilter = ['pascalConfig', 'projectPath', 'disableChecks', 'tags'];

  const commandLineArgs = [];

  for(const prop in commandArgs) {
    if (prop !== '_' && !optionsToFilter.includes(prop)) {
      commandLineArgs.push(`--${prop}=${commandArgs[prop]}`);
    }
  }

  const argv = [
    'protractor.conf.js',
    `--pascalConfig=${getConfigPath()}`,
    `--projectPath=${process.cwd()}`,
    '--disableChecks',
    ...getScenariosTags(),
    ...commandLineArgs
  ];

  child_process.spawn(path.join('node_modules', '.bin', 'protractor'), argv, {
    stdio: 'inherit',
    cwd: path.join(__dirname, '..')
  }).once('close', () => {
    console.log('Protractor has finished');
  });
}
